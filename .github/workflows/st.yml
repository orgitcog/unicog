name: SpaceTime Build

# Builds components in dependency order: cogutil -> atomspace -> cogserver -> attention -> unify -> ure -> miner -> asmoses

permissions:
  contents: read
  actions: read


# NOTE: This workflow rebuilds dependencies multiple times.
# Consider using Docker images or build artifacts to optimize build time.
# See: https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  MAKEFLAGS: -j2

jobs:

  # Stage 11: Build SpaceTime (depends on CogServer)
  build-spacetime:
    runs-on: ubuntu-latest
    name: Build SpaceTime
#    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        # Cache apt packages
      set -euo pipefail
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-cache-${{ runner.os }}-${{ hashFiles('**/*.yml') }}
          restore-keys: |
            apt-cache-${{ runner.os }}-
      
      - name: Install Dependencies
        run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen \
          liboctomap-dev
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig

    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check SpaceTime Directory
      run: |
        set -euo pipefail
        if [ -d "spacetime" ]; then
          echo "SpaceTime directory exists"
          ls -la spacetime/
        else
          echo "SpaceTime directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p spacetime/build
        cd spacetime/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        sudo make install
        sudo ldconfig

  # Stage 12: Build PLN (depends on URE and SpaceTime)
#  build-pln:
#    runs-on: ubuntu-latest
#    name: Build PLN (Probabilistic Logic Networks)
#    needs: [build-ure, build-spacetime]
    
#    steps:
#    - name: Checkout Repository
#      uses: actions/checkout@v4
#      with:
#        submodules: false
    
#    - name: Install Dependencies
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y \
#          cmake \
#          build-essential \
#          cxxtest \
#          binutils-dev \
#          libiberty-dev \
#          libboost-dev \
#          libboost-filesystem-dev \
#          libboost-program-options-dev \
#          libboost-system-dev \
#          libboost-thread-dev \
#          guile-3.0-dev \
#          libasio-dev \
#          cython3 \
#          python3-nose \
#          python3-dev \
#          valgrind \
#          doxygen
    
#    - name: Rebuild and Install CogUtil
#      run: |
#        mkdir -p cogutil/build
#        cd cogutil/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
    
#    - name: Rebuild and Install AtomSpace
#      run: |
#        mkdir -p atomspace/build
#        cd atomspace/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig

#    - name: Rebuild and Install AtomSpace Storage
#      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
#      run: |
#        mkdir -p atomspace-storage/build
#        cd atomspace-storage/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
#      continue-on-error: true
    
#    - name: Rebuild and Install CogServer
#      if: hashFiles('cogserver/CMakeLists.txt') != ''
#      run: |
#        mkdir -p cogserver/build
#        cd cogserver/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
    
#    - name: Rebuild and Install Unify
#      if: hashFiles('unify/CMakeLists.txt') != ''
#      run: |
#        mkdir -p unify/build
#        cd unify/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
    
#    - name: Rebuild and Install URE
#      if: hashFiles('ure/CMakeLists.txt') != ''
#      run: |
#        mkdir -p ure/build
#        cd ure/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
    
#    - name: Rebuild and Install SpaceTime
#      if: hashFiles('spacetime/CMakeLists.txt') != ''
#      run: |
#        mkdir -p spacetime/build
#        cd spacetime/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
#        make ${{ env.MAKEFLAGS }}
#        sudo make install
#        sudo ldconfig
    
#    - name: Check PLN Directory
#      run: |
#        if [ -d "pln" ]; then
#          echo "PLN directory exists"
#          ls -la pln/
#        else
#          echo "PLN directory not found, skipping build"
#          exit 0
#        fi
    
#    - name: Configure PLN
#      if: hashFiles('pln/CMakeLists.txt') != ''
#      run: |
#        mkdir -p pln/build
#        cd pln/build
#        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
#    - name: Build PLN
#      if: hashFiles('pln/CMakeLists.txt') != ''
#      run: |
#        cd pln/build
#        make ${{ env.MAKEFLAGS }}
    
#    - name: Build Tests
#      if: hashFiles('pln/CMakeLists.txt') != ''
#      run: |
#        cd pln/build
#        make ${{ env.MAKEFLAGS }} tests
#      continue-on-error: true
    
#    - name: Run Tests
#      if: hashFiles('pln/CMakeLists.txt') != ''
#      run: |
#        cd pln/build
#        make check ARGS="${{ env.MAKEFLAGS }}"
#      continue-on-error: true
    
#    - name: Install PLN
#      if: hashFiles('pln/CMakeLists.txt') != ''
#      run: |
#        cd pln/build
#        sudo make install
#        sudo ldconfig
 
