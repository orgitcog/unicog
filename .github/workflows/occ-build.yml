name: OCC Build - Complete Stack

# This workflow builds the OpenCog Collection (OCC) monorepo
# Based on CircleCI configurations and CMakeLists.txt from various components
# Builds components in dependency order: cogutil -> atomspace -> cogserver -> attention -> unify -> ure -> miner -> asmoses

permissions:
  contents: read
  actions: read


# NOTE: This workflow rebuilds dependencies multiple times.
# Consider using Docker images or build artifacts to optimize build time.
# See: https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  MAKEFLAGS: -j2

jobs:
  # Stage 1: Build CogUtil (Foundation)
  build-cogutil:
    runs-on: ubuntu-latest
    name: Build CogUtil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Cache CCache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-cogutil-${{ runner.os }}-${{ hashFiles('cogutil/**') }}
        restore-keys: |
          ccache-cogutil-${{ runner.os }}-
    
    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-cache-${{ runner.os }}-${{ hashFiles('**/*.yml') }}
        restore-keys: |
          apt-cache-${{ runner.os }}-
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          python3-nose \
          valgrind \
          doxygen \
          ccache
    
    - name: Configure CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build CogUtil
      run: |
        set -euo pipefail
        cd cogutil/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build CogUtil Tests
      run: |
        set -euo pipefail
        cd cogutil/build
        make ${{ env.MAKEFLAGS }} tests
    
    - name: Run CogUtil Tests
      run: |
        set -euo pipefail
        cd cogutil/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      run: |
        set -euo pipefail
        if [ -f cogutil/build/tests/Testing/Temporary/LastTest.log ]; then
          cat cogutil/build/tests/Testing/Temporary/LastTest.log
        fi
    
    - name: Install CogUtil
      run: |
        set -euo pipefail
        cd cogutil/build
        sudo make install
        sudo ldconfig
    
    - name: Upload CogUtil Build
      uses: actions/upload-artifact@v5
      with:
        name: cogutil-build
        path: |
          cogutil/build/**/*.so*
          cogutil/build/**/*.a
        retention-days: 1

  # Stage 2: Build AtomSpace (depends on CogUtil)
  build-atomspace:
    runs-on: ubuntu-latest
    name: Build AtomSpace
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Cache CCache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-atomspace-${{ runner.os }}-${{ hashFiles('atomspace/**') }}
        restore-keys: |
          ccache-atomspace-${{ runner.os }}-
    
    - name: Cache GHC
      uses: actions/cache@v4
      with:
        path: ~/.stack
        key: ghc-${{ runner.os }}-${{ hashFiles('atomspace/opencog/haskell/stack.yaml') }}
        restore-keys: |
          ghc-${{ runner.os }}-
    
    - name: Cache Haskell Dependencies
      uses: actions/cache@v4
      with:
        path: atomspace/opencog/haskell/.stack-work
        key: haskelldeps-${{ runner.os }}-${{ hashFiles('atomspace/opencog/haskell/stack.yaml', 'atomspace/opencog/haskell/opencog-atomspace.cabal') }}
        restore-keys: |
          haskelldeps-${{ runner.os }}-
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          guile-3.0-dev \
          libgmp-dev \
          cython3 \
          python3-nose \
          python3-dev \
          python3-pip \
          valgrind \
          doxygen \
          ccache
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Configure AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build AtomSpace
      run: |
        set -euo pipefail
        cd atomspace/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build AtomSpace Tests
      run: |
        set -euo pipefail
        cd atomspace/build
        make ${{ env.MAKEFLAGS }} tests
    
    - name: Run AtomSpace Tests
      run: |
        set -euo pipefail
        cd atomspace/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      run: |
        set -euo pipefail
        if [ -f atomspace/build/tests/Testing/Temporary/LastTest.log ]; then
          cat atomspace/build/tests/Testing/Temporary/LastTest.log
        fi
    
    - name: Install AtomSpace
      run: |
        set -euo pipefail
        cd atomspace/build
        sudo make install
        sudo ldconfig
    
    - name: Build Examples
      run: |
        set -euo pipefail
        cd atomspace/build
        make ${{ env.MAKEFLAGS }} examples
      continue-on-error: true
    
    - name: Upload AtomSpace Build
      uses: actions/upload-artifact@v5
      with:
        name: atomspace-build
        path: |
          atomspace/build/**/*.so*
          atomspace/build/**/*.a
        retention-days: 1

  # Stage 3: Build AtomSpace Storage (depends on AtomSpace)
  build-atomspace-storage:
    runs-on: ubuntu-latest
    name: Build AtomSpace Storage
    needs: build-atomspace
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check AtomSpace Storage Directory
      run: |
        set -euo pipefail
        if [ -d "atomspace-storage" ]; then
          echo "AtomSpace Storage directory exists"
          ls -la atomspace-storage/
        else
          echo "AtomSpace Storage directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-storage/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-storage/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-storage/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-storage/build
        sudo make install
        sudo ldconfig

  # Stage 3b: Build AtomSpace Rocks (depends on AtomSpace Storage)
  build-atomspace-rocks:
    runs-on: ubuntu-latest
    name: Build AtomSpace RocksDB Storage
    needs: build-atomspace-storage
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          librocksdb-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Verify AtomSpace Storage Installation
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        echo "Checking for AtomSpaceStorageConfig.cmake..."
        find /usr/local -name "*AtomSpaceStorage*Config.cmake" || echo "AtomSpaceStorageConfig.cmake not found"
        ls -la /usr/local/lib/cmake/ || echo "No cmake directory"
        ls -la /usr/local/share/cmake/ || echo "No share/cmake directory"
    
    - name: Check AtomSpace Rocks Directory
      run: |
        set -euo pipefail
        if [ -d "atomspace-rocks" ]; then
          echo "AtomSpace Rocks directory exists"
          ls -la atomspace-rocks/
        else
          echo "AtomSpace Rocks directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure AtomSpace Rocks
      if: hashFiles('atomspace-rocks/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-rocks/build
        cd atomspace-rocks/build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_PREFIX_PATH="/usr/local/lib/cmake;/usr/local/share/cmake"
    
    - name: Build AtomSpace Rocks
      if: hashFiles('atomspace-rocks/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-rocks/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('atomspace-rocks/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-rocks/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('atomspace-rocks/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-rocks/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install AtomSpace Rocks
      if: hashFiles('atomspace-rocks/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-rocks/build
        sudo make install
        sudo ldconfig

  # Stage 4: Build CogServer (depends on AtomSpace)
  build-cogserver:
    runs-on: ubuntu-latest
    name: Build CogServer
    needs: build-atomspace-storage
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Verify Asio Installation
      run: |
        set -euo pipefail
        echo "Checking for Asio installation..."
        ls -la /usr/include/asio.hpp || echo "WARNING: asio.hpp not found in /usr/include"
        ls -la /usr/share/pkgconfig/asio.pc || echo "WARNING: asio.pc not found"
        pkg-config --modversion asio || echo "WARNING: Asio not found via pkg-config"
        pkg-config --cflags asio || echo "WARNING: Could not get Asio cflags"
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Build and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Check CogServer Directory
      run: |
        set -euo pipefail
        if [ -d "cogserver" ]; then
          echo "CogServer directory exists"
          ls -la cogserver/
        else
          echo "CogServer directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd cogserver/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd cogserver/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd cogserver/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd cogserver/build
        sudo make install
        sudo ldconfig

  # Stage 4b: Build AtomSpace Cog (depends on CogServer)
  build-atomspace-cog:
    runs-on: ubuntu-latest
    name: Build AtomSpace Cog Network Storage
    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Verify Asio Installation
      run: |
        set -euo pipefail
        echo "Checking for Asio installation..."
        ls -la /usr/include/asio.hpp || echo "WARNING: asio.hpp not found in /usr/include"
        ls -la /usr/share/pkgconfig/asio.pc || echo "WARNING: asio.pc not found"
        pkg-config --modversion asio || echo "WARNING: Asio not found via pkg-config"
        pkg-config --cflags asio || echo "WARNING: Could not get Asio cflags"
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check AtomSpace Cog Directory
      run: |
        set -euo pipefail
        if [ -d "atomspace-cog" ]; then
          echo "AtomSpace Cog directory exists"
          ls -la atomspace-cog/
        else
          echo "AtomSpace Cog directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure AtomSpace Cog
      if: hashFiles('atomspace-cog/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-cog/build
        cd atomspace-cog/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build AtomSpace Cog
      if: hashFiles('atomspace-cog/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-cog/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('atomspace-cog/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-cog/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('atomspace-cog/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-cog/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install AtomSpace Cog
      if: hashFiles('atomspace-cog/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd atomspace-cog/build
        sudo make install
        sudo ldconfig

  # Stage 5: Build Unify (depends on AtomSpace)
  build-unify:
    runs-on: ubuntu-latest
    name: Build Unify
    needs: build-atomspace
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check Unify Directory
      run: |
        set -euo pipefail
        if [ -d "unify" ]; then
          echo "Unify directory exists"
          ls -la unify/
        else
          echo "Unify directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p unify/build
        cd unify/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd unify/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd unify/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd unify/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd unify/build
        sudo make install
        sudo ldconfig

  # Stage 6: Build URE (depends on AtomSpace and Unify)
  build-ure:
    runs-on: ubuntu-latest
    name: Build URE (Unified Rule Engine)
    needs: build-unify
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p unify/build
        cd unify/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check URE Directory
      run: |
        set -euo pipefail
        if [ -d "ure" ]; then
          echo "URE directory exists"
          ls -la ure/
        else
          echo "URE directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p ure/build
        cd ure/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd ure/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd ure/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd ure/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd ure/build
        sudo make install
        sudo ldconfig

  # Stage 7: Build Miner (depends on URE)
  build-miner:
    runs-on: ubuntu-latest
    name: Build Miner
    needs: build-ure
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Cache GHC
      uses: actions/cache@v4
      with:
        path: ~/.stack
        key: ghc-miner-${{ runner.os }}-${{ hashFiles('atomspace/opencog/haskell/stack.yaml') }}
        restore-keys: |
          ghc-miner-${{ runner.os }}-
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p unify/build
        cd unify/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p ure/build
        cd ure/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check Miner Directory
      run: |
        set -euo pipefail
        if [ -d "miner" ]; then
          echo "Miner directory exists"
          ls -la miner/
        else
          echo "Miner directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure Miner
      if: hashFiles('miner/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p miner/build
        cd miner/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build Miner
      if: hashFiles('miner/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd miner/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('miner/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd miner/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('miner/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd miner/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install Miner
      if: hashFiles('miner/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd miner/build
        sudo make install
        sudo ldconfig

  # Stage 8: Build Attention (depends on CogServer)
  build-attention:
    runs-on: ubuntu-latest
    name: Build Attention
    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Verify Asio Installation
      run: |
        set -euo pipefail
        echo "Checking for Asio installation..."
        ls -la /usr/include/asio.hpp || echo "WARNING: asio.hpp not found in /usr/include"
        ls -la /usr/share/pkgconfig/asio.pc || echo "WARNING: asio.pc not found"
        pkg-config --modversion asio || echo "WARNING: Asio not found via pkg-config"
        pkg-config --cflags asio || echo "WARNING: Could not get Asio cflags"
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check Attention Directory
      run: |
        set -euo pipefail
        if [ -d "attention" ]; then
          echo "Attention directory exists"
          ls -la attention/
        else
          echo "Attention directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure Attention
      if: hashFiles('attention/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p attention/build
        cd attention/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build Attention
      if: hashFiles('attention/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd attention/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('attention/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd attention/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('attention/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd attention/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install Attention
      if: hashFiles('attention/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd attention/build
        sudo make install
        sudo ldconfig

  # Stage 9: Build AS-MOSES (depends on AtomSpace and URE)
  build-asmoses:
    runs-on: ubuntu-latest
    name: Build AS-MOSES
    needs: build-ure
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p unify/build
        cd unify/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p ure/build
        cd ure/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check AS-MOSES Directory
      run: |
        set -euo pipefail
        if [ -d "asmoses" ]; then
          echo "AS-MOSES directory exists"
          ls -la asmoses/
        else
          echo "AS-MOSES directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure AS-MOSES
      if: hashFiles('asmoses/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p asmoses/build
        cd asmoses/build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBoost_NO_SYSTEM_PATHS=OFF
    
    - name: Build AS-MOSES
      if: hashFiles('asmoses/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd asmoses/build
        make ${{ env.MAKEFLAGS }}
    
    # Temporary fix: install asmoses to please the unit tests
    # Note: Some AS-MOSES unit tests require the libraries to be installed
    # before they can run. This matches the pattern from CircleCI config.
    - name: Install AS-MOSES
      if: hashFiles('asmoses/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd asmoses/build
        sudo make install
        sudo ldconfig
    
    - name: Build Tests
      if: hashFiles('asmoses/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd asmoses/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('asmoses/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd asmoses/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true

  # Stage 10: Build Matrix (depends on AtomSpace)
  build-matrix:
    runs-on: ubuntu-latest
    name: Build Matrix
    needs: build-atomspace
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check Matrix Directory
      run: |
        set -euo pipefail
        if [ -d "matrix" ]; then
          echo "Matrix directory exists"
          ls -la matrix/
        else
          echo "Matrix directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure Matrix
      if: hashFiles('matrix/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p matrix/build
        cd matrix/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build Matrix
      if: hashFiles('matrix/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd matrix/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('matrix/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd matrix/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('matrix/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd matrix/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install Matrix
      if: hashFiles('matrix/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd matrix/build
        sudo make install
        sudo ldconfig

  # Stage 11: Build SpaceTime (depends on CogServer)
  build-spacetime:
    runs-on: ubuntu-latest
    name: Build SpaceTime
    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen \
          liboctomap-dev
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig

    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check SpaceTime Directory
      run: |
        set -euo pipefail
        if [ -d "spacetime" ]; then
          echo "SpaceTime directory exists"
          ls -la spacetime/
        else
          echo "SpaceTime directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p spacetime/build
        cd spacetime/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd spacetime/build
        sudo make install
        sudo ldconfig

  # Stage 12: Build PLN (depends on URE and SpaceTime)
  build-pln:
    runs-on: ubuntu-latest
    name: Build PLN (Probabilistic Logic Networks)
    needs: [build-ure, build-spacetime]
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen \
          liboctomap-dev
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig

    - name: Rebuild and Install AtomSpace Storage
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install Unify
      if: hashFiles('unify/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p unify/build
        cd unify/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install URE
      if: hashFiles('ure/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p ure/build
        cd ure/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install SpaceTime
      if: hashFiles('spacetime/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p spacetime/build
        cd spacetime/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check PLN Directory
      run: |
        set -euo pipefail
        if [ -d "pln" ]; then
          echo "PLN directory exists"
          ls -la pln/
        else
          echo "PLN directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure PLN
      if: hashFiles('pln/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p pln/build
        cd pln/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build PLN
      if: hashFiles('pln/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd pln/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('pln/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd pln/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('pln/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd pln/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install PLN
      if: hashFiles('pln/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd pln/build
        sudo make install
        sudo ldconfig

  # Stage 13: Build Learn (depends on CogServer)
  build-learn:
    runs-on: ubuntu-latest
    name: Build Learn
    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        submodules: false
    
    - name: Install Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          cxxtest \
          binutils-dev \
          libiberty-dev \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          guile-3.0-dev \
          libasio-dev \
          cython3 \
          python3-nose \
          python3-dev \
          valgrind \
          doxygen
    
    - name: Verify Asio Installation
      run: |
        set -euo pipefail
        echo "Checking for Asio installation..."
        ls -la /usr/include/asio.hpp || echo "WARNING: asio.hpp not found in /usr/include"
        ls -la /usr/share/pkgconfig/asio.pc || echo "WARNING: asio.pc not found"
        pkg-config --modversion asio || echo "WARNING: Asio not found via pkg-config"
        pkg-config --cflags asio || echo "WARNING: Could not get Asio cflags"
    
    - name: Rebuild and Install CogUtil
      run: |
        set -euo pipefail
        mkdir -p cogutil/build
        cd cogutil/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace
      run: |
        set -euo pipefail
        mkdir -p atomspace/build
        cd atomspace/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Rebuild and Install AtomSpace Storage
      # Note: atomspace-storage is optional, so we continue even if it fails
      if: hashFiles('atomspace-storage/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p atomspace-storage/build
        cd atomspace-storage/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
      continue-on-error: true
    
    - name: Rebuild and Install CogServer
      if: hashFiles('cogserver/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p cogserver/build
        cd cogserver/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        make ${{ env.MAKEFLAGS }}
        sudo make install
        sudo ldconfig
    
    - name: Check Learn Directory
      run: |
        set -euo pipefail
        if [ -d "learn" ]; then
          echo "Learn directory exists"
          ls -la learn/
        else
          echo "Learn directory not found, skipping build"
          exit 0
        fi
    
    - name: Configure Learn
      if: hashFiles('learn/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        mkdir -p learn/build
        cd learn/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build Learn
      if: hashFiles('learn/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd learn/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Build Tests
      if: hashFiles('learn/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd learn/build
        make ${{ env.MAKEFLAGS }} tests
      continue-on-error: true
    
    - name: Run Tests
      if: hashFiles('learn/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd learn/build
        make check ARGS="${{ env.MAKEFLAGS }}"
      continue-on-error: true
    
    - name: Install Learn
      if: hashFiles('learn/CMakeLists.txt') != ''
      run: |
        set -euo pipefail
        cd learn/build
        sudo make install
        sudo ldconfig

  # Final Stage: Package and Report
  package-and-report:
    runs-on: ubuntu-latest
    name: Package OCC Build
    needs:
      - build-miner
      - build-attention
      - build-asmoses
      - build-matrix
      - build-spacetime
      - build-pln
      - build-learn
      - build-atomspace-rocks
      - build-atomspace-cog
    if: always()
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v6
      with:
        path: artifacts
      continue-on-error: true
    
    - name: Generate Build Report
      run: |
        set -euo pipefail
        echo "# OCC Build Report" > BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "## Build Summary" >> BUILD_REPORT.md
        echo "Build completed at: $(date)" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "## Components Built" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        
        if [ -d "artifacts" ]; then
          echo "### Artifacts Generated:" >> BUILD_REPORT.md
          ls -lh artifacts/ >> BUILD_REPORT.md
        else
          echo "No artifacts found" >> BUILD_REPORT.md
        fi
        
        echo "" >> BUILD_REPORT.md
        echo "## Build Order" >> BUILD_REPORT.md
        echo "1. CogUtil (Foundation)" >> BUILD_REPORT.md
        echo "2. AtomSpace (Hypergraph DB)" >> BUILD_REPORT.md
        echo "3. AtomSpace Storage (Storage backends)" >> BUILD_REPORT.md
        echo "3b. AtomSpace Rocks (RocksDB storage)" >> BUILD_REPORT.md
        echo "4. CogServer (Networking)" >> BUILD_REPORT.md
        echo "4b. AtomSpace Cog (Network storage)" >> BUILD_REPORT.md
        echo "5. Unify (Unification)" >> BUILD_REPORT.md
        echo "6. URE (Unified Rule Engine)" >> BUILD_REPORT.md
        echo "7. Miner (Pattern Mining)" >> BUILD_REPORT.md
        echo "8. Attention (Attention Allocation)" >> BUILD_REPORT.md
        echo "9. AS-MOSES (Meta-Optimizing Semantic Evolutionary Search)" >> BUILD_REPORT.md
        echo "10. Matrix (Sparse Vector/Matrix operations)" >> BUILD_REPORT.md
        echo "11. SpaceTime (Spatiotemporal representation)" >> BUILD_REPORT.md
        echo "12. PLN (Probabilistic Logic Networks)" >> BUILD_REPORT.md
        echo "13. Learn (Language Learning)" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "## Notes" >> BUILD_REPORT.md
        echo "- This workflow mirrors the CircleCI configuration" >> BUILD_REPORT.md
        echo "- Components are built in dependency order" >> BUILD_REPORT.md
        echo "- Tests are run but allowed to fail (continue-on-error)" >> BUILD_REPORT.md
        echo "- Build artifacts are cached for 1 day" >> BUILD_REPORT.md
        
        cat BUILD_REPORT.md
    
    - name: Upload Build Report
      uses: actions/upload-artifact@v5
      with:
        name: occ-build-report
        path: BUILD_REPORT.md
        retention-days: 30
