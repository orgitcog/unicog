name: Chocolatey Package Builder (Experimental)

# NOTE: This workflow is experimental and currently disabled.
# Native Windows MSVC support for cogutil requires significant work to resolve
# Windows header conflicts (objidl.h, winsock2.h) and Unix API replacements.
# See: https://github.com/OzCog/opencog-unified/issues for tracking.
#
# Current status: CMake configuration passes, but compilation fails due to:
# 1. Windows header order conflicts (objidl.h 'string' syntax error)
# 2. Boost source_location.hpp std::_snprintf issue
# 3. Logger.h enum/class member visibility issues with Windows headers
#
# For now, OpenCog components should be built on Linux/macOS or WSL on Windows.

permissions:
  contents: read
  actions: read

on:
  # Disabled automatic triggers - manual dispatch only for testing
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'language-learning/**'
  #     - 'cogutil/**'
  #     - 'atomspace/**'
  #     - '.github/workflows/chocolatey-packaging.yml'
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to package'
        required: true
        default: 'cogutil'
        type: choice
        options:
          - cogutil
          - atomspace
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  # Default values for push-triggered runs (workflow_dispatch inputs override these)
  DEFAULT_COMPONENT: cogutil
  DEFAULT_VERSION: '1.0.0'

jobs:
  build-chocolatey-packages:
    runs-on: windows-latest
    name: Build Chocolatey Package
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Install Chocolatey
      run: |
        $ErrorActionPreference = 'Stop'
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        choco --version
      shell: powershell
    
    - name: Install Dependencies
      run: |
        $ErrorActionPreference = 'Stop'
        choco install -y cmake 7zip
        cd C:\vcpkg
        # Install all required Boost components for cogutil
        .\vcpkg install boost-filesystem:x64-windows boost-system:x64-windows boost-thread:x64-windows boost-program-options:x64-windows boost-algorithm:x64-windows boost-lexical-cast:x64-windows boost-spirit:x64-windows
      shell: powershell
    
    - name: Build Component
      run: |
        $ErrorActionPreference = 'Stop'
        # Use workflow_dispatch input if available, otherwise use default
        $component = "${{ github.event.inputs.component }}"
        if ([string]::IsNullOrEmpty($component)) {
          $component = "${{ env.DEFAULT_COMPONENT }}"
        }
        Write-Host "Building component: $component"
        
        if (Test-Path $component) {
          mkdir "$component\build" -Force
          cd "$component\build"
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake
          cmake --build . --config Release --parallel 2
        } else {
          Write-Host "Component directory '$component' not found - skipping build"
        }
      shell: powershell
      continue-on-error: true
    
    - name: Create Package
      run: |
        $ErrorActionPreference = 'Stop'
        # Use workflow_dispatch inputs if available, otherwise use defaults
        $component = "${{ github.event.inputs.component }}"
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($component)) {
          $component = "${{ env.DEFAULT_COMPONENT }}"
        }
        if ([string]::IsNullOrEmpty($version)) {
          $version = "${{ env.DEFAULT_VERSION }}"
        }
        Write-Host "Creating package for: $component v$version"
        
        $pkgDir = "choco-packages\opencog-$component"
        New-Item -ItemType Directory -Force -Path "$pkgDir\tools"
        
        $nuspec = "<?xml version='1.0'?><package><metadata><id>opencog-$component</id><version>$version</version><title>OpenCog $component</title><authors>OpenCog Foundation</authors><description>OpenCog $component</description></metadata></package>"
        Set-Content -Path "$pkgDir\opencog-$component.nuspec" -Value $nuspec
        
        cd $pkgDir
        choco pack
      shell: powershell
      continue-on-error: true
    
    - name: Upload Package
      uses: actions/upload-artifact@v5
      with:
        name: chocolatey-package-${{ github.event.inputs.component || 'cogutil' }}
        path: choco-packages/**/*.nupkg
        retention-days: 30
      continue-on-error: true
