name: APT Repository Builder (Experimental)

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
    inputs:
      distribution:
        description: 'Target distribution'
        required: true
        default: 'jammy'
        type: choice
        options:
          - focal
          - jammy
          - bookworm
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

env:
  BUILD_TYPE: Release

jobs:
  build-apt-repository:
    runs-on: ubuntu-latest
    name: Build APT Repository
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
    
    - name: Install Tools
      run: |
        set -eu
        sudo apt-get update
        sudo apt-get install -y devscripts debhelper build-essential cmake dpkg-dev reprepro apt-utils
        sudo apt-get install -y libboost-dev libboost-filesystem-dev libboost-program-options-dev libboost-system-dev guile-3.0-dev python3-dev cxxtest
    
    - name: Setup Repository
      run: |
        set -eu
        mkdir -p apt-repo/conf
        echo "Origin: OpenCog" > apt-repo/conf/distributions
        echo "Label: OpenCog Unified" >> apt-repo/conf/distributions
        echo "Codename: ${{ github.event.inputs.distribution }}" >> apt-repo/conf/distributions
        echo "Architectures: amd64" >> apt-repo/conf/distributions
        echo "Components: main" >> apt-repo/conf/distributions
        echo "Description: OpenCog Repository" >> apt-repo/conf/distributions
    
    - name: Build CogUtil
      run: |
        set -eu
        cd cogutil && mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        make -j2
        sudo make install
        sudo ldconfig
    
    - name: Create Repository Archive
      run: |
        set -eu
        cd apt-repo
        tar -czf ../opencog-apt-repo-${{ github.event.inputs.distribution }}.tar.gz .
    
    - name: Upload Repository
      uses: actions/upload-artifact@v5
      with:
        name: opencog-apt-repo-${{ github.event.inputs.distribution }}
        path: opencog-apt-repo-*.tar.gz
        retention-days: 90
