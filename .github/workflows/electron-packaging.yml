name: Electron Binary Packager (Experimental)

# Experimental workflow for creating Electron-based desktop applications
# Packages OpenCog components with a web UI using Electron
# Creates standalone executables for Windows, macOS, and Linux

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (e.g., OpenCog-Explorer, AtomSpace-Viewer)'
        required: true
        default: 'OpenCog-Explorer'
      version:
        description: 'Application version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      platforms:
        description: 'Target platforms (comma-separated: win,mac,linux)'
        required: true
        default: 'win,linux'

env:
  NODE_VERSION: '18'
  ELECTRON_VERSION: '27.0.0'

jobs:
  build-electron-app:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_ext: AppImage
          - os: windows-latest
            platform: win
            artifact_ext: exe
          - os: macos-latest
            platform: mac
            artifact_ext: dmg
    
    name: Build Electron App - ${{ matrix.platform }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Create Electron App Structure
      run: |
        mkdir -p electron-app/src
        mkdir -p electron-app/assets
        mkdir -p electron-app/resources
      shell: bash
    
    - name: Create package.json
      run: |
        cat > electron-app/package.json << 'EOF'
{
  "name": "opencog-explorer",
  "productName": "${{ github.event.inputs.app_name }}",
  "version": "${{ github.event.inputs.version }}",
  "description": "OpenCog Cognitive Architecture Explorer",
  "main": "src/main.js",
  "scripts": {
    "start": "electron .",
    "build": "electron-builder",
    "build:win": "electron-builder --win",
    "build:mac": "electron-builder --mac",
    "build:linux": "electron-builder --linux"
  },
  "author": "OpenCog Foundation",
  "license": "AGPL-3.0",
  "devDependencies": {
    "electron": "^27.0.0",
    "electron-builder": "^24.6.4"
  },
  "dependencies": {
    "express": "^4.18.2",
    "ws": "^8.14.2"
  },
  "build": {
    "appId": "org.opencog.explorer",
    "productName": "${{ github.event.inputs.app_name }}",
    "directories": {
      "output": "dist"
    },
    "files": [
      "src/**/*",
      "assets/**/*",
      "resources/**/*"
    ],
    "win": {
      "target": ["nsis", "portable"],
      "icon": "assets/icon.ico"
    },
    "mac": {
      "target": ["dmg", "zip"],
      "icon": "assets/icon.icns",
      "category": "public.app-category.developer-tools"
    },
    "linux": {
      "target": ["AppImage", "deb", "rpm"],
      "icon": "assets/icon.png",
      "category": "Development"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    }
  }
}
EOF
      shell: bash
    
    - name: Create Electron Main Process
      run: |
        cat > electron-app/src/main.js << 'EOF'
const { app, BrowserWindow, Menu, ipcMain } = require('electron');
const path = require('path');
const express = require('express');
const WebSocket = require('ws');

let mainWindow;
let serverApp;
let wss;

// Create Express server for API
function createServer() {
  serverApp = express();
  const port = 3000;
  
  serverApp.use(express.json());
  
  // API endpoints
  serverApp.get('/api/status', (req, res) => {
    res.json({ status: 'running', version: '${{ github.event.inputs.version }}' });
  });
  
  serverApp.get('/api/atomspace/atoms', (req, res) => {
    // Placeholder: Return sample atoms
    res.json({
      atoms: [
        { type: 'ConceptNode', name: 'OpenCog', tv: { strength: 0.9, confidence: 0.8 } },
        { type: 'ConceptNode', name: 'CognitiveArchitecture', tv: { strength: 0.85, confidence: 0.9 } }
      ]
    });
  });
  
  serverApp.listen(port, () => {
    console.log(`API server running on port ${port}`);
  });
  
  // WebSocket server for real-time updates
  wss = new WebSocket.Server({ port: 3001 });
  
  wss.on('connection', (ws) => {
    console.log('WebSocket client connected');
    
    ws.send(JSON.stringify({
      type: 'welcome',
      message: 'Connected to OpenCog Explorer'
    }));
    
    ws.on('message', (message) => {
      console.log('Received:', message);
      // Echo back for now
      ws.send(JSON.stringify({ type: 'echo', data: message.toString() }));
    });
  });
}

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false,
      preload: path.join(__dirname, 'preload.js')
    },
    icon: path.join(__dirname, '../assets/icon.png')
  });
  
  mainWindow.loadFile(path.join(__dirname, 'index.html'));
  
  // Create application menu
  const template = [
    {
      label: 'File',
      submenu: [
        { role: 'quit' }
      ]
    },
    {
      label: 'View',
      submenu: [
        { role: 'reload' },
        { role: 'toggleDevTools' },
        { type: 'separator' },
        { role: 'resetZoom' },
        { role: 'zoomIn' },
        { role: 'zoomOut' }
      ]
    },
    {
      label: 'Help',
      submenu: [
        {
          label: 'About',
          click: () => {
            const { dialog } = require('electron');
            dialog.showMessageBox({
              type: 'info',
              title: 'About ${{ github.event.inputs.app_name }}',
              message: '${{ github.event.inputs.app_name }}',
              detail: `Version: ${{ github.event.inputs.version }}\nOpenCog Cognitive Architecture Explorer\n\nLicense: AGPL-3.0`
            });
          }
        }
      ]
    }
  ];
  
  const menu = Menu.buildFromTemplate(template);
  Menu.setApplicationMenu(menu);
  
  mainWindow.on('closed', () => {
    mainWindow = null;
  });
}

app.whenReady().then(() => {
  createServer();
  createWindow();
  
  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('before-quit', () => {
  // Cleanup
  if (wss) {
    wss.close();
  }
});
EOF
      shell: bash
    
    - name: Create Preload Script
      run: |
        cat > electron-app/src/preload.js << 'EOF'
// Preload script for Electron
window.addEventListener('DOMContentLoaded', () => {
  const replaceText = (selector, text) => {
    const element = document.getElementById(selector);
    if (element) element.innerText = text;
  };

  for (const type of ['chrome', 'node', 'electron']) {
    replaceText(`${type}-version`, process.versions[type]);
  }
});
EOF
      shell: bash
    
    - name: Create HTML Interface
      run: |
        cat > electron-app/src/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${{ github.event.inputs.app_name }}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header h1 {
      color: #667eea;
      font-size: 24px;
      font-weight: 600;
    }
    
    .version-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    main {
      flex: 1;
      display: flex;
      gap: 20px;
      padding: 20px;
      overflow: hidden;
    }
    
    .panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    
    .sidebar {
      flex: 0 0 250px;
    }
    
    .content {
      flex: 1;
    }
    
    .sidebar h2, .content h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #667eea;
    }
    
    .menu-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .menu-item:hover {
      background: #f0f0f0;
    }
    
    .menu-item.active {
      background: #667eea;
      color: white;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4ade80;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .atom-list {
      list-style: none;
    }
    
    .atom-item {
      padding: 10px;
      margin: 8px 0;
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      border-radius: 4px;
    }
    
    .atom-type {
      font-weight: 600;
      color: #667eea;
    }
    
    .atom-name {
      margin: 5px 0;
    }
    
    .tv-values {
      font-size: 12px;
      color: #666;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    .log-entry {
      padding: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>${{ github.event.inputs.app_name }}</h1>
      <div class="version-info">
        Version ${{ github.event.inputs.version }} | 
        Electron: <span id="electron-version"></span> | 
        Node: <span id="node-version"></span>
      </div>
    </header>
    
    <main>
      <div class="panel sidebar">
        <h2>Navigation</h2>
        <div class="menu-item active" onclick="showPanel('atomspace')">
          <span class="status-indicator"></span>
          AtomSpace
        </div>
        <div class="menu-item" onclick="showPanel('queries')">
          Queries
        </div>
        <div class="menu-item" onclick="showPanel('reasoning')">
          Reasoning
        </div>
        <div class="menu-item" onclick="showPanel('logs')">
          System Logs
        </div>
        <div class="menu-item" onclick="showPanel('settings')">
          Settings
        </div>
      </div>
      
      <div class="panel content">
        <div id="atomspace-panel">
          <h2>AtomSpace Browser</h2>
          <p>Connected to OpenCog AtomSpace</p>
          
          <button onclick="loadAtoms()" style="margin: 20px 0;">
            Refresh Atoms
          </button>
          
          <ul class="atom-list" id="atom-list">
            <li class="atom-item">
              <div class="atom-type">ConceptNode</div>
              <div class="atom-name">"OpenCog"</div>
              <div class="tv-values">TV: (s=0.900, c=0.800)</div>
            </li>
            <li class="atom-item">
              <div class="atom-type">ConceptNode</div>
              <div class="atom-name">"CognitiveArchitecture"</div>
              <div class="tv-values">TV: (s=0.850, c=0.900)</div>
            </li>
          </ul>
        </div>
        
        <div id="other-panels" style="display: none;">
          <h2 id="panel-title">Panel</h2>
          <p id="panel-content">Select a menu item to view content</p>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // WebSocket connection
    let ws;
    
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3001');
      
      ws.onopen = () => {
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('Received:', data);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }
    
    function loadAtoms() {
      fetch('http://localhost:3000/api/atomspace/atoms')
        .then(response => response.json())
        .then(data => {
          const list = document.getElementById('atom-list');
          list.innerHTML = '';
          
          data.atoms.forEach(atom => {
            const li = document.createElement('li');
            li.className = 'atom-item';
            li.innerHTML = `
              <div class="atom-type">${atom.type}</div>
              <div class="atom-name">"${atom.name}"</div>
              <div class="tv-values">TV: (s=${atom.tv.strength.toFixed(3)}, c=${atom.tv.confidence.toFixed(3)})</div>
            `;
            list.appendChild(li);
          });
        })
        .catch(error => console.error('Error loading atoms:', error));
    }
    
    function showPanel(panelName) {
      // Update active menu item
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Show appropriate panel
      if (panelName === 'atomspace') {
        document.getElementById('atomspace-panel').style.display = 'block';
        document.getElementById('other-panels').style.display = 'none';
      } else {
        document.getElementById('atomspace-panel').style.display = 'none';
        document.getElementById('other-panels').style.display = 'block';
        document.getElementById('panel-title').textContent = panelName.charAt(0).toUpperCase() + panelName.slice(1);
        document.getElementById('panel-content').textContent = `${panelName} functionality coming soon...`;
      }
    }
    
    // Initialize
    setTimeout(connectWebSocket, 1000);
  </script>
</body>
</html>
EOF
      shell: bash
    
    - name: Create App Icon (Placeholder)
      run: |
        # Create a simple placeholder icon
        # In production, use actual icon files
        mkdir -p electron-app/assets
        echo "Icon placeholder" > electron-app/assets/icon.png
      shell: bash
    
    - name: Install Dependencies
      run: |
        cd electron-app
        npm install
      shell: bash
    
    - name: Build Electron Application
      run: |
        cd electron-app
        
        # Build for the current platform
        if [ "${{ matrix.platform }}" == "win" ]; then
          npm run build:win
        elif [ "${{ matrix.platform }}" == "mac" ]; then
          npm run build:mac
        else
          npm run build:linux
        fi
      shell: bash
      continue-on-error: true
    
    - name: List Build Artifacts
      run: |
        if [ -d "electron-app/dist" ]; then
          echo "Build artifacts:"
          ls -lh electron-app/dist/
        else
          echo "No build artifacts found"
        fi
      shell: bash
    
    - name: Upload Electron Package
      uses: actions/upload-artifact@v4
      with:
        name: electron-app-${{ matrix.platform }}-${{ github.event.inputs.version }}
        path: |
          electron-app/dist/*.${{ matrix.artifact_ext }}
          electron-app/dist/*.exe
          electron-app/dist/*.AppImage
          electron-app/dist/*.dmg
          electron-app/dist/*.deb
          electron-app/dist/*.rpm
        retention-days: 30
      continue-on-error: true
  
  create-documentation:
    runs-on: ubuntu-latest
    name: Create Installation Documentation
    needs: build-electron-app
    if: always()
    
    steps:
    - name: Create User Guide
      run: |
        cat > ELECTRON-APP-GUIDE.md << 'EOF'
# OpenCog Electron Application User Guide

## Overview

The OpenCog Electron application provides a desktop interface for exploring and interacting with the OpenCog cognitive architecture.

## Installation

### Windows

1. Download the `.exe` installer
2. Run the installer
3. Follow the installation wizard
4. Launch from Start Menu or Desktop shortcut

### Linux

**AppImage (Universal):**
```bash
chmod +x OpenCog-Explorer-${{ github.event.inputs.version }}.AppImage
./OpenCog-Explorer-${{ github.event.inputs.version }}.AppImage
```

**Debian/Ubuntu (.deb):**
```bash
sudo dpkg -i opencog-explorer_${{ github.event.inputs.version }}_amd64.deb
opencog-explorer
```

**RedHat/Fedora (.rpm):**
```bash
sudo rpm -i opencog-explorer-${{ github.event.inputs.version }}.x86_64.rpm
opencog-explorer
```

### macOS

1. Download the `.dmg` file
2. Open the DMG
3. Drag to Applications folder
4. Launch from Applications

## Features

### AtomSpace Browser
- View atoms in the knowledge base
- Filter by atom type
- Inspect truth values
- Real-time updates via WebSocket

### Query Interface
- Execute AtomSpace queries
- Pattern matching
- Save and load queries

### Reasoning Engine
- Configure reasoning rules
- Monitor inference process
- View reasoning traces

### System Logs
- Real-time log viewing
- Filter by severity
- Export logs

## Architecture

The application consists of:

- **Electron Frontend**: Desktop UI
- **Express Backend**: REST API (port 3000)
- **WebSocket Server**: Real-time updates (port 3001)
- **AtomSpace Integration**: Native bindings

## Development

To run from source:

```bash
cd electron-app
npm install
npm start
```

To build:

```bash
npm run build           # Current platform
npm run build:win       # Windows
npm run build:mac       # macOS
npm run build:linux     # Linux
```

## API Endpoints

- `GET /api/status` - Server status
- `GET /api/atomspace/atoms` - List atoms
- `POST /api/query` - Execute query
- `GET /api/reasoning/rules` - List reasoning rules

## WebSocket Events

- `welcome` - Connection established
- `atom.created` - New atom created
- `atom.updated` - Atom updated
- `atom.deleted` - Atom deleted

## Configuration

Edit configuration in:
- Windows: `%APPDATA%\opencog-explorer\config.json`
- Linux: `~/.config/opencog-explorer/config.json`
- macOS: `~/Library/Application Support/opencog-explorer/config.json`

## Troubleshooting

### Application Won't Start

**Windows:**
- Install Visual C++ Redistributable
- Check Windows Defender/Antivirus

**Linux:**
- Install required libraries: `sudo apt-get install libgtk-3-0 libnotify4 libnss3`
- For AppImage: Install FUSE

**macOS:**
- Right-click → Open (for unsigned apps)
- System Preferences → Security & Privacy

### Cannot Connect to AtomSpace

1. Check that CogServer is running
2. Verify port 17001 is accessible
3. Check firewall settings

### Performance Issues

- Reduce atom display limit
- Disable real-time updates
- Close unused panels

## Support

- GitHub Issues: https://github.com/opencog/opencog-unified/issues
- Mailing List: opencog-dev@googlegroups.com
- Wiki: https://wiki.opencog.org

## License

AGPL-3.0 License
Copyright © 2024 OpenCog Foundation

EOF
        cat ELECTRON-APP-GUIDE.md
      shell: bash
    
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: electron-app-documentation
        path: ELECTRON-APP-GUIDE.md
        retention-days: 30
