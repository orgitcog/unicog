# Pre-commit CI workflow for OpenCog Unified Repository
name: ðŸ” Pre-commit Checks

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

permissions:
  contents: read

concurrency:
  group: pre-commit-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    name: "ðŸ” Code Quality Checks"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff analysis

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "ðŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install pre-commit

      - name: "ðŸ’¾ Cache Pre-commit"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: "ðŸ” Run Pre-commit Hooks"
        run: |
          # Run pre-commit on changed files for PRs, all files for pushes to main
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pre-commit run --from-ref ${{ github.event.pull_request.base.sha }} --to-ref ${{ github.event.pull_request.head.sha }}
          else
            pre-commit run --all-files
          fi

      - name: "ðŸ“Š Generate Report"
        if: always()
        run: |
          echo "## Pre-commit Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi

  yaml-lint:
    name: "ðŸ“‹ YAML Validation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Lint YAML Files"
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yaml
          file_or_dir: |
            .github/workflows/
            *.yml
            *.yaml
          strict: false

  actionlint:
    name: "âš™ï¸ GitHub Actions Validation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Lint GitHub Actions"
        uses: reviewdog/action-actionlint@v1
        with:
          reporter: github-pr-review
          fail_on_error: true

  shellcheck:
    name: "ðŸš Shell Script Validation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Run ShellCheck"
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          check_together: 'yes'
          additional_files: '*.sh'
        env:
          SHELLCHECK_OPTS: -e SC1091 -e SC2086 -e SC2034

  python-lint:
    name: "ðŸ Python Validation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "ðŸ“¦ Install Ruff"
        run: pip install ruff

      - name: "ðŸ” Run Ruff Linter"
        run: ruff check . --output-format=github

      - name: "ðŸŽ¨ Run Ruff Formatter Check"
        run: ruff format --check .

  security-scan:
    name: "ðŸ”’ Security Scan"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "ðŸ“¦ Install detect-secrets"
        run: pip install detect-secrets

      - name: "ðŸ” Scan for Secrets"
        run: |
          detect-secrets scan --baseline .secrets.baseline
          detect-secrets audit .secrets.baseline --report --json > /dev/null || true
