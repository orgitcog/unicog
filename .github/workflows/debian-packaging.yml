name: Debian Package Builder (Experimental)

# Experimental workflow for building Debian .deb packages of OpenCog components
# Creates installable Debian packages for Ubuntu/Debian systems
# Packages include proper dependency management and systemd integration

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to package (cogutil, atomspace, cogserver, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cogutil
          - atomspace
          - cogserver
          - unify
          - ure
      version:
        description: 'Package version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  BUILD_TYPE: Release
  DEBEMAIL: "opencog-dev@googlegroups.com"
  DEBFULLNAME: "OpenCog Developers"

jobs:
  build-debian-packages:
    runs-on: ubuntu-latest
    name: Build Debian Packages
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Debian Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          devscripts \
          debhelper \
          dh-make \
          build-essential \
          cmake \
          fakeroot \
          lintian \
          dpkg-dev
    
    - name: Install OpenCog Dependencies
      run: |
        sudo apt-get install -y \
          libboost-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          guile-3.0-dev \
          python3-dev \
          cython3 \
          librocksdb-dev \
          libasio-dev \
          cxxtest
    
    - name: Setup Package Version
      run: |
        echo "PACKAGE_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
        echo "DEB_VERSION=${{ github.event.inputs.version }}-1" >> $GITHUB_ENV
    
    - name: Build CogUtil Debian Package
      if: github.event.inputs.component == 'all' || github.event.inputs.component == 'cogutil'
      run: |
        cd cogutil
        
        # Create debian directory structure
        mkdir -p debian/source
        echo "3.0 (native)" > debian/source/format
        
        # Create control file
        cat > debian/control << 'EOF'
Source: opencog-cogutil
Section: science
Priority: optional
Maintainer: OpenCog Developers <opencog-dev@googlegroups.com>
Build-Depends: debhelper (>= 10), cmake, libboost-dev, libboost-filesystem-dev, libboost-program-options-dev, libboost-system-dev, libboost-thread-dev, cxxtest
Standards-Version: 4.5.0
Homepage: https://opencog.org

Package: libcogutil-dev
Architecture: any
Depends: ${shlibs:Depends}, ${misc:Depends}, libboost-dev, libboost-filesystem-dev, libboost-program-options-dev
Description: OpenCog CogUtil - Core Utilities Library
 Core utilities library for OpenCog cognitive architecture.
 Provides foundational data structures and utilities.
EOF
        
        # Create changelog
        cat > debian/changelog << EOF
opencog-cogutil (${{ env.DEB_VERSION }}) unstable; urgency=medium

  * Automated build from GitHub Actions
  * Version ${{ env.PACKAGE_VERSION }}

 -- OpenCog Developers <opencog-dev@googlegroups.com>  $(date -R)
EOF
        
        # Create rules file
        cat > debian/rules << 'EOF'
#!/usr/bin/make -f
%:
	dh $@ --buildsystem=cmake

override_dh_auto_configure:
	dh_auto_configure -- -DCMAKE_BUILD_TYPE=Release

override_dh_auto_test:
	# Skip tests during packaging
	true
EOF
        chmod +x debian/rules
        
        # Create copyright
        cat > debian/copyright << 'EOF'
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: cogutil
Source: https://github.com/opencog/cogutil

Files: *
Copyright: 2008-2024 OpenCog Foundation
License: AGPL-3.0
 Full license text available at /usr/share/common-licenses/AGPL-3
EOF
        
        # Build package
        dpkg-buildpackage -us -uc -b
        
        # Move package to artifacts
        mkdir -p ../debian-packages
        mv ../opencog-cogutil*.deb ../debian-packages/ || true
        mv ../libcogutil*.deb ../debian-packages/ || true
    
    - name: Build AtomSpace Debian Package
      if: github.event.inputs.component == 'all' || github.event.inputs.component == 'atomspace'
      run: |
        # First install cogutil if built
        if [ -f debian-packages/libcogutil-dev*.deb ]; then
          sudo dpkg -i debian-packages/libcogutil-dev*.deb || true
          sudo apt-get install -f -y
        fi
        
        cd atomspace
        
        # Create debian directory structure
        mkdir -p debian/source
        echo "3.0 (native)" > debian/source/format
        
        # Create control file
        cat > debian/control << 'EOF'
Source: opencog-atomspace
Section: science
Priority: optional
Maintainer: OpenCog Developers <opencog-dev@googlegroups.com>
Build-Depends: debhelper (>= 10), cmake, libboost-dev, libboost-filesystem-dev, libboost-program-options-dev, libboost-system-dev, libboost-thread-dev, guile-3.0-dev, python3-dev, cython3, libcogutil-dev
Standards-Version: 4.5.0
Homepage: https://opencog.org

Package: libatomspace-dev
Architecture: any
Depends: ${shlibs:Depends}, ${misc:Depends}, libcogutil-dev, libboost-dev, guile-3.0-dev, python3
Description: OpenCog AtomSpace - Hypergraph Database
 Hypergraph database for knowledge representation in OpenCog.
 Provides atoms, values, and truth values for cognitive processing.
EOF
        
        # Create changelog
        cat > debian/changelog << EOF
opencog-atomspace (${{ env.DEB_VERSION }}) unstable; urgency=medium

  * Automated build from GitHub Actions
  * Version ${{ env.PACKAGE_VERSION }}

 -- OpenCog Developers <opencog-dev@googlegroups.com>  $(date -R)
EOF
        
        # Create rules file
        cat > debian/rules << 'EOF'
#!/usr/bin/make -f
%:
	dh $@ --buildsystem=cmake

override_dh_auto_configure:
	dh_auto_configure -- -DCMAKE_BUILD_TYPE=Release

override_dh_auto_test:
	# Skip tests during packaging
	true
EOF
        chmod +x debian/rules
        
        # Create copyright
        cat > debian/copyright << 'EOF'
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: atomspace
Source: https://github.com/opencog/atomspace

Files: *
Copyright: 2008-2024 OpenCog Foundation
License: AGPL-3.0
 Full license text available at /usr/share/common-licenses/AGPL-3
EOF
        
        # Build package
        dpkg-buildpackage -us -uc -b
        
        # Move package to artifacts
        mv ../opencog-atomspace*.deb ../debian-packages/ || true
        mv ../libatomspace*.deb ../debian-packages/ || true
    
    - name: Verify Packages with Lintian
      run: |
        if [ -d debian-packages ]; then
          echo "Running lintian on generated packages..."
          for deb in debian-packages/*.deb; do
            echo "Checking $deb"
            lintian --no-tag-display-limit "$deb" || true
          done
        fi
    
    - name: List Generated Packages
      run: |
        if [ -d debian-packages ]; then
          echo "Generated Debian packages:"
          ls -lh debian-packages/
          echo ""
          echo "Package information:"
          for deb in debian-packages/*.deb; do
            echo "=== $deb ==="
            dpkg-deb --info "$deb"
            echo ""
          done
        fi
    
    - name: Create Package Repository Metadata
      run: |
        if [ -d debian-packages ]; then
          cd debian-packages
          
          # Create Packages file
          dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
          
          # Create Release file
          cat > Release << EOF
Origin: OpenCog
Label: OpenCog Unified
Suite: stable
Codename: opencog
Architectures: amd64
Components: main
Description: OpenCog Cognitive Architecture Packages
Date: $(date -R)
EOF
          
          echo "Repository metadata created"
          ls -la
        fi
    
    - name: Upload Debian Packages
      uses: actions/upload-artifact@v4
      with:
        name: debian-packages-${{ github.event.inputs.component }}-${{ github.event.inputs.version }}
        path: debian-packages/
        retention-days: 30
    
    - name: Generate Installation Instructions
      run: |
        cat > INSTALL.md << 'EOF'
# OpenCog Debian Package Installation

## Installation from Local Packages

1. Download the .deb packages
2. Install them in dependency order:

```bash
# Install CogUtil first
sudo dpkg -i libcogutil-dev_*.deb

# Install dependencies if needed
sudo apt-get install -f

# Install AtomSpace
sudo dpkg -i libatomspace-dev_*.deb

# Fix any remaining dependencies
sudo apt-get install -f
```

## Adding to APT Repository

To add these packages to a local APT repository:

```bash
# Copy packages to repository directory
sudo mkdir -p /var/www/html/debian
sudo cp *.deb /var/www/html/debian/

# Create repository metadata
cd /var/www/html/debian
dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz

# Add to sources.list
echo "deb [trusted=yes] file:///var/www/html/debian ./" | sudo tee /etc/apt/sources.list.d/opencog.list

# Update and install
sudo apt-get update
sudo apt-get install libatomspace-dev
```

## Verification

Verify installation:
```bash
dpkg -l | grep opencog
ldconfig -p | grep cogutil
ldconfig -p | grep atomspace
```

EOF
        cat INSTALL.md
    
    - name: Upload Installation Instructions
      uses: actions/upload-artifact@v4
      with:
        name: debian-install-instructions
        path: INSTALL.md
        retention-days: 30
