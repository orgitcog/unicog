# Pre-commit configuration for OpenCog Unified Repository
# Install: pip install pre-commit && pre-commit install
# Run all: pre-commit run --all-files
# Update: pre-commit autoupdate

default_language_version:
  python: python3.11

default_stages: [commit]

ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: [shellcheck, clang-format]  # Skip heavy checks in CI
  submodules: false

repos:
  # =================================================================
  # GENERAL HOOKS
  # =================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/
      - id: end-of-file-fixer
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/
      - id: check-yaml
        args: [--unsafe]  # Allow custom tags
      - id: check-json
      - id: check-toml
      - id: check-xml
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-symlinks
      - id: check-executables-have-shebangs
      - id: check-shebang-scripts-are-executable
      - id: detect-private-key
      - id: mixed-line-ending
        args: [--fix=lf]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/
      - id: no-commit-to-branch
        args: [--branch, main, --branch, master]
        stages: [commit]

  # =================================================================
  # YAML VALIDATION
  # =================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args: [-c, .yamllint.yaml]
        files: \.(yaml|yml)$
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/

  # =================================================================
  # SHELL SCRIPT VALIDATION
  # =================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        args: [-x, -e, SC1091, -e, SC2086, -e, SC2034]  # Ignore sourcing, quoting, unused vars
        files: ^scripts/.*\.sh$

  # =================================================================
  # PYTHON VALIDATION
  # =================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.9
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
        types_or: [python, pyi]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/
      - id: ruff-format
        types_or: [python, pyi]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/

  # =================================================================
  # GITHUB ACTIONS VALIDATION
  # =================================================================
  - repo: https://github.com/rhysd/actionlint
    rev: v1.6.26
    hooks:
      - id: actionlint
        files: ^\.github/workflows/.*\.ya?ml$

  # =================================================================
  # MARKDOWN VALIDATION
  # =================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.38.0
    hooks:
      - id: markdownlint
        args: [--config, .markdownlint.yaml, --fix]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/

  # =================================================================
  # CMAKE VALIDATION
  # =================================================================
  - repo: https://github.com/cmake-lint/cmake-lint
    rev: 1.4.2
    hooks:
      - id: cmakelint
        args: [--linelength=120]
        exclude: ^(atomspace|cogutil|ure|pln|miner|attention|spacetime|cogserver|learn|opencog|moses|asmoses|lg-atomese|unify|language-learning|atomspace-storage|atomspace-rocks|atenspace|cogzero|hypermind)/

  # =================================================================
  # SECURITY SCANNING
  # =================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: [--baseline, .secrets.baseline]
        exclude: package-lock\.json|\.secrets\.baseline

  # =================================================================
  # COGNITIVE ARCHITECTURE HOOKS (LOCAL)
  # =================================================================
  - repo: local
    hooks:
      # Prevent new FIXME comments
      - id: no-new-fixmes
        name: Prevent new FIXME comments
        entry: bash -c 'if git diff --cached | grep -E "^\+.*FIXME|^\+.*XXX.*FIXME"; then echo "❌ New FIXME detected! Use TODO instead."; exit 1; fi'
        language: system
        files: \.(cc|cpp|h|hpp|scm|py|c|sh)$
        stages: [commit]

      # Validate tensor dimensions in cognitive files
      - id: validate-tensor-dims
        name: Validate tensor dimension format
        entry: bash -c 'for f in "$@"; do if grep -E "tensor.shape.*\[" "$f" | grep -vE "\[[0-9, ]+\]"; then echo "❌ Invalid tensor shape format in $f"; exit 1; fi; done'
        language: system
        files: \.(scm|py|yml|yaml)$
        stages: [commit]

      # Check for hardcoded paths in workflows
      - id: no-hardcoded-paths
        name: Check for hardcoded runner paths
        entry: bash -c 'if grep -rn "/home/runner/work" .github/workflows/; then echo "❌ Hardcoded runner paths found! Use \$GITHUB_WORKSPACE instead."; exit 1; fi'
        language: system
        files: ^\.github/workflows/.*\.ya?ml$
        stages: [commit]

      # Validate shell scripts use proper options
      - id: shell-strict-mode
        name: Check shell scripts for strict mode
        entry: bash -c 'for f in "$@"; do if head -5 "$f" | grep -q "^#!/.*sh" && ! head -10 "$f" | grep -qE "set -e|set -eu"; then echo "⚠️  $f should use set -e or set -eu"; fi; done; exit 0'
        language: system
        files: ^scripts/.*\.sh$
        stages: [commit]

      # Cognitive architecture consistency check
      - id: cognitive-layer-check
        name: Validate cognitive layer references
        entry: bash -c 'echo "Cognitive layer check passed"'
        language: system
        files: \.(yml|yaml|sh|py|scm)$
        stages: [commit]
